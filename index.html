<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Speaky Studio Recorder</title>
  <meta name="viewport" content="width=600">
  <style>
    /* ... Use your previous CSS styles here ... */
    .cue-category-header {
      background: #e3e9f7;
      font-weight: bold;
      font-size: 1.07em;
      letter-spacing: 1px;
      padding: 13px 10px;
      border-bottom: 2px solid #d0d8e6;
      color: #444;
    }
    .dark .cue-category-header {
      background: #23283a;
      color: #e9eefa;
      border-bottom: 2px solid #2c2f3a;
    }
    /* add any other styles from the version you use */
  </style>
</head>
<body>
  <!-- ... The rest of your structure (controls, audio, buttons) ... -->
  <div class="container" role="main">
    <h1>Speaky Studio Recorder</h1>
    <div class="recorder-controls" aria-label="Recording controls">
      <button id="recordBtn" class="main-btn" aria-label="Record (Space)" tabindex="0">Record</button>
      <button id="stopBtn" class="main-btn" aria-label="Stop (Enter)" disabled tabindex="0">Stop</button>
      <button id="playAllBtn" class="main-btn" aria-label="Play All" disabled tabindex="0">Play All</button>
      <button id="themeToggle" class="main-btn" aria-label="Toggle dark mode" title="Toggle dark mode" tabindex="0">üåô</button>
    </div>
    <div class="audio-section">
      <audio id="player" controls style="width:100%; max-width:350px; display:none;" aria-label="Session audio"></audio>
    </div>
    <div class="add-cues">
      <strong>Add a Cue:</strong><br>
      <button class="cue-btn cue-falsefriend" id="cueFalseFriend" title="Mark a False Friend (F)" aria-label="Add False Friend cue (F)" tabindex="0">
        <i>ü§î</i> False Friend<kbd>F</kbd>
      </button>
      <button class="cue-btn cue-vocab" id="cueVocab" title="Mark a Vocabulary Opportunity (V)" aria-label="Add Vocabulary cue (V)" tabindex="0">
        <i>üìñ</i> Vocabulary<kbd>V</kbd>
      </button>
      <button class="cue-btn cue-pronun" id="cuePronun" title="Mark a Pronunciation Opportunity (P)" aria-label="Add Pronunciation cue (P)" tabindex="0">
        <i>üó£Ô∏è</i> Pronunciation<kbd>P</kbd>
      </button>
      <button class="cue-btn cue-grammar" id="cueGrammar" title="Mark a Grammar Opportunity (G)" aria-label="Add Grammar cue (G)" tabindex="0">
        <i>‚úçÔ∏è</i> Grammar<kbd>G</kbd>
      </button>
    </div>
    <table class="cue-list-table" id="cueTable" style="display:none;" aria-label="Cues table">
      <thead>
        <tr>
          <th scope="col">Type</th>
          <th scope="col">Time</th>
          <th scope="col">Notes</th>
          <th scope="col">Play</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="session-actions">
      <button class="save-btn" id="saveSessionBtn" style="display:none;" aria-label="Save Session">Save Session</button>
      <span id="savedMsg" class="saved-msg" style="display:none;">Session saved!</span>
    </div>
  </div>
  <script>
    // -- Cue type order and map --
    const cueTypeOrder = ['vocab','falsefriend','pronun','grammar'];
    const cueTypeMap = {
      falsefriend: {label:'False Friend', color:'#ff9800', icon:'ü§î'},
      vocab:       {label:'Vocabulary',   color:'#1976d2', icon:'üìñ'},
      pronun:      {label:'Pronunciation',color:'#43a047', icon:'üó£Ô∏è'},
      grammar:     {label:'Grammar',      color:'#7e57c2', icon:'‚úçÔ∏è'}
    };

    // ... (rest of your setup and state: theme, buttons, etc.)

    let mediaRecorder, audioChunks = [], audioUrl = null, cues = [], recordingStartTime = 0, isSessionSaved = false;
    // ... (button queries, theme toggling, etc.)

    // --- GROUPED TABLE RENDERING ---
    function updateCueTable() {
      cueTableBody.innerHTML = '';
      if (cues.length === 0) {
        cueTable.style.display = 'none';
        return;
      }
      cueTable.style.display = '';

      if (!isSessionSaved) {
        // Before saving: show cues in the order they were added
        cues.forEach((cue, idx) => cueTableBody.appendChild(renderCueRow(cue, idx)));
      } else {
        // After saving: group cues by type, in the defined order
        cueTypeOrder.forEach(type => {
          const group = cues.filter(c => c.type === type);
          if (group.length > 0) {
            // Add a row as a header for the category
            const catTr = document.createElement('tr');
            const catTd = document.createElement('td');
            catTd.colSpan = 4;
            catTd.className = "cue-category-header";
            catTd.textContent = cueTypeMap[type].label;
            catTr.appendChild(catTd);
            cueTableBody.appendChild(catTr);

            group.forEach((cue, idx) => cueTableBody.appendChild(renderCueRow(cue, idx, true)));
          }
        });
      }
    }

    function renderCueRow(cue, idx, isGrouped=false) {
      const tr = document.createElement('tr');
      // Type
      const typeCell = document.createElement('td');
      typeCell.innerHTML = `<span class="cue-type-dot" style="background:${cueTypeMap[cue.type].color}"></span>
        <span title="${cueTypeMap[cue.type].label}">${cueTypeMap[cue.type].icon}</span>
        <span> ${cueTypeMap[cue.type].label}</span>`;
      tr.appendChild(typeCell);

      // Time
      const timeCell = document.createElement('td');
      timeCell.textContent = cue.time.toFixed(2) + 's';
      tr.appendChild(timeCell);

      // Notes
      const noteCell = document.createElement('td');
      if (!isSessionSaved) {
        const textarea = document.createElement('textarea');
        textarea.className = 'cue-note-input';
        textarea.rows = 1;
        textarea.placeholder = "Type notes (optional)...";
        textarea.value = cue.note;
        textarea.setAttribute('aria-label', `Notes for ${cueTypeMap[cue.type].label} at ${cue.time.toFixed(2)}s`);
        textarea.oninput = (e) => {
          cues[idx].note = e.target.value;
        };
        noteCell.appendChild(textarea);
      } else {
        noteCell.textContent = cue.note || '‚Äî';
      }
      tr.appendChild(noteCell);

      // Play
      const playCell = document.createElement('td');
      const playBtn = document.createElement('button');
      playBtn.className = 'cue-play-btn';
      playBtn.textContent = '‚ñ∂';
      playBtn.type = "button";
      playBtn.setAttribute('aria-label', `Play ${cueTypeMap[cue.type].label} cue from 8s before to 2s after`);
      playBtn.disabled = !audioUrl;
      playBtn.onclick = () => {
        if (!audioUrl) return;
        let start = Math.max(0, cue.time - 8);
        let end = cue.time + 2;
        if (player.src !== audioUrl) {
          player.src = audioUrl;
          player.load();
        }
        player.onended = null;
        player.ontimeupdate = null;
        function stopAtEnd() {
          if (player.currentTime >= end) {
            player.pause();
            player.ontimeupdate = null;
          }
        }
        const seekAndPlay = () => {
          if (player.readyState >= 2) {
            player.currentTime = start;
            player.play();
            player.ontimeupdate = stopAtEnd;
            player.removeEventListener('canplay', seekAndPlay);
          }
        };
        if (player.readyState >= 2) {
          seekAndPlay();
        } else {
          player.addEventListener('canplay', seekAndPlay);
        }
      };
      playCell.appendChild(playBtn);
      tr.appendChild(playCell);

      return tr;
    }

    // ... The rest of your session logic, event handlers, etc. ...

    // On save, switch to grouped view
    saveSessionBtn.onclick = async () => {
      if (!audioUrl || isSessionSaved) return;
      isSessionSaved = true;
      updateCueTable();
      // ... your save logic ...
      savedMsg.style.display = '';
      saveSessionBtn.disabled = true;
    };

    // ... rest of your script (keyboard shortcuts etc.) ...
    updateCueTable();
  </script>
</body>
</html>
